name: Auto Release

on:
  push:
    branches: [ main, master ]
    paths:
      - 'metadata.yaml'
      - 'CHANGELOG.md'

jobs:
  release:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'

      - name: Extract version from metadata.yaml
        id: extract_version
        run: |
          VERSION=$(grep -E '^version: ' metadata.yaml | awk '{print $2}')
          echo "version=$VERSION" >> $GITHUB_OUTPUT

      - name: Extract changelog for version
        id: extract_changelog
        run: |
          VERSION=${{ steps.extract_version.outputs.version }}
          # 使用Python脚本提取对应版本的变更日志，将版本号作为命令行参数传递
          python3 -c "
          import re
          import sys
          
          if len(sys.argv) != 2:
              print('Usage: python script.py <version>')
              sys.exit(1)
          
          version = sys.argv[1]
          
          try:
              with open('CHANGELOG.md', 'r', encoding='utf-8') as f:
                  content = f.read()
              
              # 匹配指定版本的变更日志
              pattern = r'## \[v' + re.escape(version) + r'\] - .+?\n(.*?)(?=## \[|$)'
              match = re.search(pattern, content, re.DOTALL)
              
              if match:
                  changelog = match.group(1).strip()
                  # 去除空行
                  lines = [line for line in changelog.split('\n') if line.strip()]
                  changelog = '\n'.join(lines)
                  print(changelog)
              else:
                  print(f'No changelog found for version v{version}', file=sys.stderr)
                  sys.exit(1)
          except Exception as e:
              print(f'Error: {e}', file=sys.stderr)
              sys.exit(1)
          " "$VERSION" > changelog.txt
          
          # 检查是否有错误输出
          if [ -s changelog.txt ]; then
              CHANGELOG=$(cat changelog.txt)
          else
              echo "Failed to extract changelog"
              exit 1
          fi
          
          # 将变更日志内容设置为output，注意处理多行文本
          CHANGELOG="${CHANGELOG//'%'/'%25'}"
          CHANGELOG="${CHANGELOG//$'\n'/'%0A'}"
          CHANGELOG="${CHANGELOG//$'\r'/'%0D'}"
          echo "changelog=$CHANGELOG" >> $GITHUB_OUTPUT

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          tag_name: v${{ steps.extract_version.outputs.version }}
          name: Release v${{ steps.extract_version.outputs.version }}
          body: ${{ steps.extract_changelog.outputs.changelog }}
          draft: false
          prerelease: false
