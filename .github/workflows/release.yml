name: Auto Release

on:
  push:
    branches: [ main, master ]
    paths:
      - 'metadata.yaml'
      - 'CHANGELOG.md'

jobs:
  release:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'

      - name: Extract version from metadata.yaml
        id: extract_version
        run: |
          VERSION=$(grep -E '^version: ' metadata.yaml | awk '{print $2}')
          echo "version=$VERSION" >> $GITHUB_OUTPUT

      - name: Extract changelog for version
        id: extract_changelog
        run: |
          VERSION=${{ steps.extract_version.outputs.version }}
          # 使用shell命令提取对应版本的变更日志
          # 找到对应版本的行号
          VERSION_LINE=$(grep -n "## \[v$VERSION\]" CHANGELOG.md | head -n 1 | cut -d: -f1)
          
          if [ -z "$VERSION_LINE" ]; then
              echo "No changelog found for version v$VERSION"
              exit 1
          fi
          
          # 找到下一个版本的行号
          NEXT_VERSION_LINE=$(tail -n +$((VERSION_LINE + 1)) CHANGELOG.md | grep -n "## \[" | head -n 1 | cut -d: -f1)
          
          if [ -z "$NEXT_VERSION_LINE" ]; then
              # 如果是最后一个版本，提取从VERSION_LINE到文件末尾
              CHANGELOG=$(tail -n +$((VERSION_LINE + 1)) CHANGELOG.md)
          else
              # 否则提取从VERSION_LINE到下一个版本之前
              END_LINE=$((VERSION_LINE + NEXT_VERSION_LINE - 1))
              CHANGELOG=$(sed -n "$((VERSION_LINE + 1)),$((END_LINE - 1))p" CHANGELOG.md)
          fi
          
          # 去除前后空白和空行
          CHANGELOG=$(echo "$CHANGELOG" | sed '/^$/d')
          
          # 将变更日志内容设置为output，注意处理多行文本
          CHANGELOG="${CHANGELOG//'%'/'%25'}"
          CHANGELOG="${CHANGELOG//$'\n'/'%0A'}"
          CHANGELOG="${CHANGELOG//$'\r'/'%0D'}"
          echo "changelog=$CHANGELOG" >> $GITHUB_OUTPUT

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          tag_name: v${{ steps.extract_version.outputs.version }}
          name: Release v${{ steps.extract_version.outputs.version }}
          body: ${{ steps.extract_changelog.outputs.changelog }}
          draft: false
          prerelease: false
