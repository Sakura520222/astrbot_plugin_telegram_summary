# Telegram 频道消息总结插件

> **当前版本：v1.2.0** | [更新日志](CHANGELOG.md)

本插件转自我的另一个项目：[Sakura-Channel-Summary-Assistant](https://github.com/Sakura520222/Sakura-Channel-Summary-Assistant)

一个适用于AstrBot的 Telegram 频道消息总结插件，每周自动生成指定频道的消息汇总报告，支持自动推送到QQ群组和用户。

**核心特性**：
- 📅 智能定时任务：每周一自动生成周报
- 🤖 AI驱动总结：自动提取核心要点和重要消息
- 📤 自动推送：支持推送到QQ群组和用户
- 🔄 交互式登录：通过熟悉的 QQ 聊天界面完成登录，无需切换终端，小白友好

## 功能特性

- **自动周报**：每周一早上 9 点自动生成指定频道的消息总结
- **自动推送**：支持将频道总结自动推送到指定的 QQ 群组和用户
- **AI 总结**：使用 AI 模型提取核心要点并整理重要消息
- **灵活配置**：支持配置多个频道、自定义提示词和 AI 参数
- **多频道支持**：同时监控多个 Telegram 频道
- **命令控制**：支持通过命令手动触发总结、管理频道和配置参数
- **智能时间记录**：记录每次总结的时间，下一次总结从该时间点开始获取消息，避免重复总结

## 安装

1. 克隆或下载插件到 AstrBot 的插件目录
2. 安装依赖：
   ```bash
   pip install -r requirements.txt
   ```
3. 重启AstrBot

## 配置

### AstrBot 配置系统

通过 AstrBot 的配置系统进行配置，配置项包括：

- `telegram.api_id`: Telegram API ID
- `telegram.api_hash`: Telegram API Hash
- `_special.select_provider`: AI 提供商选择
- `channels`: 要监控的频道列表
- `prompt`: 自定义提示词
- `auto_summary_time`: 自动总结执行时间（格式：`周一 09:00`）
- `auto_push_groups`: 自动推送的群组列表
- `auto_push_users`: 自动推送的用户列表

### 自动推送配置

插件支持将频道总结自动推送到指定的 QQ 群组和用户：

```yaml
# 推送到群组
auto_push_groups:
  - 123456789

# 推送给用户
auto_push_users:
  - 987654321
```

**配置说明**：
- `auto_push_groups`：填写群号，每行一个
- `auto_push_users`：填写用户ID（QQ号），每行一个
- 推送时自动添加 1-3 秒随机延迟，避免触发平台风控

## 使用说明

### 自动总结与推送

插件会在配置的时间（默认为每周一早上 9 点）自动生成所有配置频道的消息总结，并推送到配置的群组和用户。

### 手动触发

您可以通过以下命令手动触发总结：

```
/summary          # 生成所有频道的总结
/summary example  # 只生成指定频道的总结（需提供频道名称）
```

💡 **智能提示**：如果未登录，使用 `/summary` 命令时会自动启动登录流程。

### 交互式登录（仅限管理员）

插件支持通过 QQ 聊天界面完成 Telegram 账号登录，使用会话控制：

**用户账号登录**（三步流程）：
```
用户: /tg_login
Bot: 🚀 **开始 Telegram 登录流程**
    请输入您的手机号（必须带国家代码）
    示例：`+8613812345678`
    ⏱️ 会话将在 120 秒后超时

用户: +8613812345678                    ← 直接输入，无需命令前缀
Bot: 📡 正在连接到 Telegram 服务器并请求验证码...
    📩 **验证码已发送**
    验证码已发送到您的 Telegram 应用或短信
    请输入您收到的验证码

用户: 12345                             ← 直接输入，无需命令前缀
Bot: ✅ **登录成功！**
    您的 Telegram 账号已成功登录
    Session 已保存，后续将自动使用此账号

（如需两步验证）
用户: my_password                       ← 直接输入密码
Bot: ✅ **登录成功！**
```

💡 **提示**：
- 任何时候发送 `退出` 都可以取消登录流程
- **登录命令仅限管理员使用**

登录成功后，session 文件会自动保存到 `user_session.session`，重启后自动加载，无需重复登录。

## 命令列表

| 命令 | 描述 | 权限 |
|------|------|------|
| `/summary [channel]` | 立即生成本周频道消息总结，可指定频道 | 管理员 |
| `/showprompt` | 查看当前使用的提示词 | 管理员 |
| `/setprompt` | 设置自定义提示词 | 管理员 |
| `/showchannels` | 查看当前配置的频道列表 | 管理员 |
| `/addchannel <url>` | 添加新的监控频道 | 管理员 |
| `/deletechannel <url>` | 删除监控频道 | 管理员 |
| `/clearsummarytime` | 清除上次总结时间记录 | 管理员 |
| `/tg_login` | 开始 Telegram 用户账号登录流程（支持会话控制，无需命令前缀输入） | 管理员 |

## 工作原理

1. **定时任务**：使用 APScheduler 每周一早上 9 点触发总结任务
2. **消息抓取**：通过 Telethon 库抓取从上次总结时间至今指定频道的所有文本消息
3. **AI 分析**：将抓取的消息发送给 AI 模型进行总结分析
4. **报告发送**：将分析结果分段发送给配置的管理员
5. **时间记录**：记录当前总结时间，用于下次总结时确定消息获取范围

## 依赖

- telethon: Telegram API 客户端库
- python-dotenv: 环境变量加载库
- openai: OpenAI API 客户端库
- apscheduler: 任务调度库

## 登录说明

### 为什么需要交互式登录？

- **无头环境支持**：服务器或 Docker 环境通常无法访问命令行交互界面
- **便捷操作**：通过熟悉的 QQ 聊天界面完成登录，无需切换终端

### 登录流程

1. 发送 `/tg_login` 命令
2. 按照提示逐步输入登录信息（手机号、验证码、密码等）
3. 登录成功后，session 自动保存到 `user_session.session`
4. 后续操作自动使用已保存的 session，无需重复登录

### 安全提示

- 输入两步验证密码后，建议手动撤回该消息以保护隐私
- Session 文件经过加密，存储在本地数据目录中
- 登录信息仅用于 Telegram API 认证，不会上传到其他服务器

## 注意事项

1. 确保您的 Telegram 账号已加入目标频道
2. 建议使用 DeepSeek 或其他支持长文本处理的 AI 模型
3. 首次使用时，建议先通过 `/tg_login` 完成 Telegram 用户账号登录
4. 登录成功后，建议通过 `/summary` 命令手动测试，确保配置正确
5. 总结报告可能会根据消息量和 AI 模型的不同而有所延迟
6. 如需重新登录，删除对应的 session 文件后再次执行登录命令即可

## 日志

插件使用 AstrBot 提供的日志接口，您可以在 AstrBot 的日志中查看插件的运行状态和错误信息。

## 开发者

- 作者：车厘子小樱/Sakura520222
- 项目地址：https://github.com/Sakura520222/astrbot_plugin_telegram_summary

## 许可证

MIT License
